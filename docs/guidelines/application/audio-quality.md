# 音声ファイル品質保証ガイドライン

## 概要

伊勢節カラオケアプリでは、ピッチ検出の精度を確保するため、音声ファイル（WAV形式）の品質検証機能を実装しています。このガイドラインでは、音声ファイルの品質要件、検証プロセス、および問題解決方法について説明します。

## 音声ファイル要件

### サポートされる形式
- **ファイル形式**: WAV（PCMエンコード）
- **チャンネル数**: モノラル（1ch）またはステレオ（2ch）
- **ビット深度**: 16bit
- **サンプリングレート**: 8kHz ～ 96kHz（推奨: 44.1kHz または 48kHz）

### 品質要件
- **ブロックアライン値**: 正しく計算された値（16bitステレオの場合は4bytes）
- **バイトレート値**: 正しく計算された値（サンプリングレート × ブロックアライン）
- **初期無音期間**: 1秒以内（推奨: 0.5秒以内）
- **ファイル破損**: なし

## 検証プロセス

### 自動検証のタイミング
アプリは以下のタイミングで音声ファイルを自動検証します：

1. **楽曲選択時**: ユーザーが楽曲を選択した瞬間
2. **カラオケ画面遷移前**: 音声ファイル読み込み直前

### 検証項目

#### 1. ファイル形式検証
- RIFFヘッダーの確認
- WAVEシグネチャの確認
- ヘッダーサイズの確認（最低44バイト）

#### 2. オーディオ形式検証
- チャンネル数（1-2チャンネルのみサポート）
- ビット深度（16bitのみサポート）
- サンプリングレート（有効範囲内）

#### 3. ヘッダー整合性検証
```
ブロックアライン = (ビット深度 × チャンネル数) ÷ 8
バイトレート = サンプリングレート × ブロックアライン
```

#### 4. 音声品質検証
- 初期無音期間の長さ
- PCMデータの有効性

## エラー処理

### 検証失敗時の動作
音声ファイルに問題が検出された場合：

1. **エラーダイアログ表示**: 検出された問題の詳細を表示
2. **修正方法の案内**: 外部ツールによる修正手順を説明
3. **楽曲選択画面への復帰**: ユーザーは楽曲選択画面に戻る

### エラーダイアログの内容
- 楽曲名とファイル情報
- 検出された問題のリスト
- 各問題の解決策
- 修正ツールの使用方法

## 修正ツール

### 利用可能なツール

音声ファイルの問題は、アプリ外部のコマンドラインツールで修正できます：

#### 1. 単一ファイル修正ツール
```bash
dart tools/scripts/fix_wav_file.dart assets/sounds/ファイル名.wav
```

**機能**:
- ブロックアライン値の自動修正
- バイトレート値の自動修正
- 初期無音期間の削除（オプション）
- 元ファイルの自動バックアップ

#### 2. 全ファイル検証・修正ツール
```bash
dart tools/scripts/validate_all_wavs.dart
```

**機能**:
- 全WAVファイルの一括検証
- 問題ファイルのリスト表示
- 一括修正オプション
- 修正結果の検証

### 修正ツールの特徴

#### 安全性
- **自動バックアップ**: 修正前に元ファイルを自動保存
- **非破壊的修正**: ヘッダー情報のみ修正、音声データは保持
- **検証機能**: 修正後の結果を自動検証

#### 使いやすさ
- **対話式インターフェース**: ユーザーに確認を求める
- **詳細な進行状況**: 修正プロセスを段階的に表示
- **エラーハンドリング**: 問題発生時の分かりやすいメッセージ

## よくある問題と解決策

### 1. ブロックアライン不正
**症状**: ピッチ検出が常に330Hzを返す
**原因**: スマホ録音アプリのヘッダー生成バグ
**解決策**: `fix_wav_file.dart`で自動修正

### 2. 初期無音期間過長
**症状**: ピッチ検出の開始が遅い
**原因**: 録音開始時の無音期間
**解決策**: 音声編集ソフトでトリミング、または修正ツールの無音削除機能

### 3. サポート外形式
**症状**: ファイル形式エラー
**原因**: MP3やその他の形式
**解決策**: WAV形式での再録音または変換

### 4. ファイル破損
**症状**: 読み込みエラー
**原因**: ファイル転送時の破損
**解決策**: ファイルの再作成

## 開発者向け情報

### ツールのビルドから除外

修正ツールは実行時アプリには含まれません：

- **配置場所**: `tools/scripts/`ディレクトリ
- **実行方法**: コマンドライン（Dart CLI）
- **依存関係**: Dart SDKのみ（Flutter不要）

### 検証ライブラリの利用

アプリ内検証は`WavValidator`クラスを使用：

```dart
final result = await WavValidator.validateWavFile(filePath);
if (!result.isValid) {
  // エラー処理
}
```

### カスタマイズ

検証基準や修正動作は以下で調整可能：
- `lib/services/wav_validator.dart`: 検証ロジック
- `tools/scripts/fix_wav_file.dart`: 修正ロジック

## まとめ

この品質保証システムにより：

1. **ユーザー体験の向上**: ピッチ検出の精度確保
2. **問題の早期発見**: 楽曲選択時の自動検証
3. **簡単な修正**: 外部ツールによる自動修正
4. **安全な操作**: バックアップ機能付き修正

音声ファイルに問題が検出された場合は、このガイドラインに従って修正を行ってください。
