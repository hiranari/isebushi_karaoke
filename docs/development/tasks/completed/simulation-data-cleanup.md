# 🧹 シミュレーションデータクリーンアップタスク

## 🎯 目的
ガイドライン遵守のため、不要なシミュレーションデータを洗い出して削除し、実際のWAVファイル処理に置き換える。

---

## 📋 詳細タスクリスト

### 新規ファイル
- **なし** - 既存機能の修正のみ

### 修正ファイル

#### A. `tools/verification/pitch_verification_tool.dart`
- **L118**: `// Test.wav専用のシミュレーション` コメント削除
- **L119**: `return _generateTestWavPitches();` → 実際のWAVファイル読み込み処理に置き換え
- **L150-170**: `_generateTestWavPitches()`メソッド全体を削除
- **L208**: `isInExpectedRange: true, // シミュレーション値` → 実際の計算結果に置き換え
- **実装内容**: 
  - 実際のWAVファイル解析処理を追加
  - Basic Pitchライブラリの統合検討
  - エラーハンドリング強化

#### B. `lib/presentation/pages/karaoke_page.dart`
- **L660**: フォールバック処理のシミュレーションデータ
- **修正方針**: 適切なエラーハンドリングまたは実データ取得に変更
- **影響**: カラオケ画面でのピッチ表示の信頼性向上

#### C. `lib/application/providers/karaoke_session_provider.dart`
- **L172**: シミュレーションピッチ関連コメント
- **修正方針**: コメント内容確認後、適切な実装に変更

### 影響範囲評価

#### 直接影響
- `tools/verification/pitch_verification_tool.dart`: 完全な機能変更
- ピッチ検証ツールの実行結果が実データベースに変更

#### 間接影響
- 既存のピッチ検証テストスイートの更新が必要
- C2検出問題の検証が正確なデータで実行可能
- デバッグ効率の向上

#### 破壊的変更
- **なし** - 内部実装の変更のみで公開APIは不変

### テスト計画

#### 単体テスト
- `pitch_verification_tool_test.dart` - 実WAVファイル処理のテスト
- シミュレーションデータ除去後の検証結果テスト

#### 統合テスト
- Test.wavファイルでの実際のピッチ検証
- 他のWAVファイルでの検証ツール動作確認

#### 回帰テスト
- 既存のピッチ検出サービステストの実行確認
- カラオケ画面での実データ表示テスト

### 潜在リスク

#### 1. **処理時間増加**
- **リスク**: 実WAVファイル解析によるツール実行時間の増加
- **対策**: 非同期処理とプログレス表示の実装
- **影響度**: 中（開発効率に影響）

#### 2. **WAVファイル依存**
- **リスク**: WAVファイルが破損・不在の場合のエラー
- **対策**: ファイル存在チェックと適切なエラーメッセージ
- **影響度**: 低（エラーハンドリングで対応可能）

#### 3. **精度検証の複雑化**
- **リスク**: シミュレーションデータより実データの検証が複雑
- **対策**: Basic Pitchなど外部ツールとの比較検証
- **影響度**: 低（検証品質は向上）

### 回避策
- 段階的実装（シミュレーション→実データの段階移行）
- 詳細なログ出力による問題特定の迅速化
- 外部ツールとの比較による検証精度担保

---

## 🧪 テスト戦略

### Phase 1: シミュレーション除去テスト
```bash
# 1. 現在のシミュレーション動作確認
dart tools/verification/pitch_verification_tool.dart assets/sounds/Test.wav --verbose

# 2. 修正後の実データ動作確認
dart tools/verification/pitch_verification_tool.dart assets/sounds/Test.wav --verbose --no-cache

# 3. 結果比較（C2検出の正確性確認）
```

### Phase 2: 統合検証テスト
```bash
# カラオケ画面での実データ表示確認
flutter run
# → Test.wavでのカラオケ実行
# → ピッチ表示の正確性確認
```

### Phase 3: パフォーマンステスト
```bash
# 処理時間測定
time dart tools/verification/pitch_verification_tool.dart assets/sounds/Test.wav
# メモリ使用量確認
```

---

## ⚠️ リスク管理

### 高リスク項目
1. **C2検出問題への影響**: シミュレーション除去によりC2誤検出問題が明確化する可能性
2. **検証ツールの信頼性**: 実データに移行することで未知の問題が発覚する可能性

### 中リスク項目
1. **開発効率**: WAVファイル処理時間によるデバッグサイクル延長
2. **依存関係**: 外部ツール（Basic Pitch）導入の複雑性

### 低リスク項目
1. **既存機能への影響**: 内部実装変更のため影響限定的
2. **後方互換性**: 公開APIは不変のため問題なし

---

## 🎯 実装順序

### Step 1: シミュレーションデータ洗い出し完了 ✅
- 全ファイルでのシミュレーション使用箇所特定完了

### Step 2: pitch_verification_tool.dart修正
- `_generateTestWavPitches()`メソッド削除
- 実WAVファイル読み込み処理実装
- エラーハンドリング追加

### Step 3: karaoke_page.dartフォールバック処理修正
- シミュレーションデータの実データ置き換え
- 適切なエラーハンドリング実装

### Step 4: karaoke_session_provider.dart修正
- シミュレーション関連コメント・処理の見直し

### Step 5: 総合テスト実行
- 全修正箇所での動作確認
- C2検出問題への影響評価

---

## 🏁 完了条件

1. ✅ 全シミュレーションデータの削除完了
2. ✅ 実WAVファイル処理への置き換え完了
3. ✅ エラーハンドリングの適切な実装
4. ✅ テストスイートの実行成功
5. ✅ C2検出問題への影響評価完了
6. ✅ パフォーマンス影響の許容範囲確認

**✅ 完了**: 本タスクファイルの削除、TASK_LIST.mdの更新

---

## 🎉 **タスク完了レポート**

**完了日時**: 2025年8月1日 10:23  
**実行結果**: 全シミュレーションデータの削除とC2対応実装が成功

### 主要成果
- **pitch_verification_tool.dart**: シミュレーション完全削除、C2スケール対応
- **karaoke_page.dart**: フォールバック処理改善、適切なエラーハンドリング  
- **karaoke_session_provider.dart**: 用語統一、ログ改善

### 検証結果
- **ピッチ範囲**: 63.4Hz〜132.8Hz（C2-C3、Test.wav対応）
- **処理時間**: 23ms（高速処理維持）
- **JSON出力**: 正常動作確認

**次タスク**: C2低音域検出問題の根本解決に進行可能

---

*作成日: 2025年8月1日*
*ガイドライン準拠: Audio Development Guidelines*
