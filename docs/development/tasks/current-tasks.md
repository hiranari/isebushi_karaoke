# 🎯 Isebushi Karaoke - 残タスクリスト

> **自動削除ポリシー**: このファイル内の全てのタスクが完了したら、このファイル自体を削除してください。

## 📋 現在の状況
- **作成日**: 2025年7月29日
- **現在ブランチ**: copilot/fix-e14957fd-f22b-4af8-9758-246edf71f633
- **最新の成果**: print文エラー完全解消、ガイドライン強化、自動執行メカニズム構築

---

## ✅ 完了済みタスク
- [x] **Task 1-7**: リファクタリングタスク1-7完了
- [x] **Task 8**: サービスクラス間の循環依存解決
- [x] **Task 9**: DebugLoggerの設計改善とコンストラクタ修正
- [x] **CopilotDebugBridge**: デバッグアクセス機能実装
- [x] **ガイドライン強化**: AUDIO_DEVELOPMENT_GUIDELINES.md更新
- [x] **print文撲滅**: 全print()文をdebugPrint()に変換完了
- [x] **自動執行**: analysis_options.yamlでavoid_printをerror-levelに設定
- [x] **VS Code統合**: .vscode/settings.jsonで即座問題表示設定

---

## 🔄 進行中タスク

### 0. 基準ピッチ検証・デバッグ機能 🎯 **【最優先】**
- [x] **外部ツールから基準ピッチ算出**
  - `tools/testing/test_reference_pitch.dart`の作成 ✅
  - WAVファイルパス引数での基準ピッチ抽出 ✅
  - 既存の`test_pitch_detection.dart`と同様な引数構成 ✅
  - キャッシュ使用/無視オプション ✅
  - 詳細統計情報の出力 ✅

- [x] **カラオケ画面でのキャッシュピッチ出力**
  - キャッシュからピッチ読み込み時のデバッグ出力 ✅
  - `CopilotDebugBridge`へのピッチ情報出力 ✅
  - 基準ピッチとキャッシュピッチの比較表示 ✅

### 1. コード品質改善 🔧
- [x] **prefer_const_constructors警告対応**
  - 96個のinfo-level警告をすべて解消 ✅
  - 対象ファイル: `lib/presentation/pages/song_select_page.dart`、`wav_validator.dart` 完了 ✅

### 2. 非推奨API対応 ⚠️
- [x] **withOpacity()の置き換え**
  - `withOpacity()` → `withValues()` への変換 ✅
  - 対象: `lib/presentation/widgets/realtime_score_widget.dart` ✅
  - 対象: `lib/presentation/widgets/pitch_visualization_widget.dart` ✅

### 3. BuildContext非同期使用改善 🔄
- [x] **use_build_context_synchronously警告対応**
  - `mounted`チェックの追加 ✅
  - 対象: `lib/presentation/pages/karaoke_page.dart` ✅

---

## 🆕 新規タスク

### 4. 機能拡張・改善 🚀
- [x] **基準ピッチ検証ツール強化** 🎯
  - [x] **Domain層: ピッチ検証インターフェース定義**
    - `IPitchVerificationService` 抽象クラス作成 ✅
    - 検証結果モデル `PitchVerificationResult` 作成 ✅
    - JSON出力用の `verifyPitchData` メソッド定義 ✅
  - [x] **Infrastructure層: 検証サービス実装**
    - `PitchVerificationService` 具象クラス実装 ✅
    - 既存 `_loadReferencePitches` ロジックの抽出・共通化 ✅
    - JSON形式での検証結果出力機能 ✅
  - [x] **Tools層: 外部検証ツール拡張**
    - `tools/verification/pitch_verification_tool.dart` 作成 ✅
    - WAVファイルパス引数での実行機能 ✅
    - 検証結果のJSON出力（`./verification_results/`） ✅
  - [x] **Application層: ユースケース統合**
    - `VerifyPitchUseCase` 作成 ✅
    - カラオケ画面とツールの共通ロジック統一 ✅
    - DRY原則に従ったコード重複排除 ✅

- [ ] **C2低音域検出問題の解決** 🎯 **【緊急対応必要】**
  - **問題**: Test.wavのC2ドレミファソラシド（65-130Hz）が2オクターブ上のC4（260-520Hz）として誤検出
  - **根本原因**: ピッチ検出範囲制限（minPitchHz=80Hz）によるハーモニクス誤認識
  - [ ] **即効対応: 検出範囲拡張** ⚡
    - `PitchDetectionService.minPitchHz` を 80.0 → 65.0 に変更
    - `PitchDetectionService.maxPitchHz` を 600.0 → 1000.0 に変更
    - C2基本周波数（65.41Hz）を確実にカバーする最適値
    - 女性高音域（~1100Hz）をカバーし、カラオケ実用性を大幅向上
    - 電源ハム（50/60Hz）除外とTest.wav対応を両立
    - 影響範囲: 単一定数変更のため安全性高
  - [ ] **根本解決: ハーモニクス分析強化** 🔧
    - 基本周波数とハーモニクスを区別するロジック追加
    - スペクトラム解析で低次ハーモニクス強度評価機能
    - オクターブ補正アルゴリズムの音楽理論ベース改良
  - [ ] **最適化: 低音域特化調整** 🎵
    - バッファサイズの低周波数検出向け最適化検討
    - C2（65Hz、周期15ms）に対する解析窓長調整
    - 複数オクターブ候補評価による最適解選択機能
  - [ ] **検証・テスト** 🧪
    - Test.wav以外のC2音階ファイルでの動作確認
    - Basic Pitchなど他ツールとの比較検証実施
    - 低音域検出の精度・性能ベンチマーク測定

- [ ] **音声品質向上**
  - Test_improved.wavの音質最適化
  - ピッチ検出精度の向上
  - リアルタイム処理の最適化

- [ ] **ユーザー体験向上**
  - 楽曲選択UIの改善
  - スコア表示の視覚化強化
  - フィードバック機能の充実

- [ ] **パフォーマンス最適化**
  - メモリ使用量の最適化
  - 録音・再生の遅延改善
  - バックグラウンド処理の効率化

### 5. テスト・品質保証 🧪
- [ ] **単体テスト強化**
  - サービスクラスのテストカバレッジ向上
  - ピッチ検出のテストケース追加
  - UI Widgetテストの充実

- [ ] **統合テスト実装**
  - E2E テストシナリオ作成
  - 録音→分析→スコア表示の一連フロー検証
  - 音声ファイル処理のテスト

### 6. ドキュメント・メンテナンス 📚
- [ ] **APIドキュメント整備**
  - Dartdocの充実
  - アーキテクチャ図の更新
  - 開発ガイドラインの詳細化

- [ ] **デプロイメント準備**
  - CI/CDパイプライン設定
  - リリースビルド最適化
  - ストア申請準備

---

## 🎯 優先度ランキング

### 🔥 最優先度（即座対応）
1. **C2低音域検出問題の解決** - Test.wav誤検出の根本修正、ピッチ検出精度の信頼性確保
2. **基準ピッチ検証ツール強化** - カラオケ画面基準ピッチ問題の根本解決
3. **BuildContext非同期使用改善** - アプリ安定性に直結
3. **非推奨API対応** - 将来の互換性確保

### ⚡ 中優先度（近日中）
4. **prefer_const_constructors対応** - コード品質向上
5. **音声品質向上** - ユーザー体験の核心
6. **単体テスト強化** - 保守性確保

### 📈 低優先度（中長期）
7. **パフォーマンス最適化** - 継続的改善
8. **統合テスト実装** - 品質保証強化
9. **ドキュメント整備** - 開発効率向上
10. **デプロイメント準備** - リリース準備

---

## 📝 作業メモ

### 🛠️ 技術的負債
- `song_select_page.dart`にconst constructorが大量に必要
- 一部のWidgetでFlutter最新APIへの移行が必要
- 非同期処理でのBuildContext使用パターンを統一する必要
- **基準ピッチ検証ロジック重複**: カラオケ画面の`_loadReferencePitches`とツールの処理が分離
- **検証結果の可視化不足**: デバッグ情報がコンソール出力のみでJSON形式未対応
- **🚨 C2低音域検出問題**: `minPitchHz=80Hz`制限により65-79Hzが検出不可、ハーモニクス誤認識
- **🚨 女性高音域検出制限**: `maxPitchHz=600Hz`により女性アルト(~700Hz)・ソプラノ(~1100Hz)が一部検出不可
- **🚨 オクターブ補正誤動作**: 範囲外ピッチの機械的2倍処理により、2オクターブ上誤検出が発生

### 💡 改善アイデア
- CopilotDebugBridgeの活用でデバッグ効率向上
- DebugFileLoggerの自動ローテーション機能
- リアルタイムピッチ可視化の3D表示化
- **基準ピッチ検証ツール**: カラオケ画面とツールの`_loadReferencePitches`ロジック統一
- **JSON出力機能**: 検証結果の構造化データ出力によるデバッグ効率向上
- **クリーンアーキテクチャ**: Domain層でのピッチ検証抽象化とDRY原則の徹底
- **🎵 低音域検出強化**: minPitchHz=65Hzへの拡張で楽器低音域（C2-B2）をカバー
- **🎵 高音域検出強化**: maxPitchHz=1000Hzへの拡張で女性高音域・アニソンをカバー
- **🎵 ハーモニクス分析**: FFTスペクトラムから基本周波数/ハーモニクス強度比較機能
- **🎵 多候補評価**: 複数オクターブのピッチ候補を音楽理論ベースで評価・選択

### ⚠️ 注意事項
- print()文は絶対に使用禁止（自動執行で検出）
- 新しいサービスクラス追加時は循環依存チェック必須
- デバッグログは必ずDebugFileLoggerを経由
- **基準ピッチ検証**: 外部ツールで算出結果をクロスチェックする

---

## 🏁 完了条件

**このタスクリストの全項目が完了したら、以下を実行してください：**

1. ✅ 全タスクのチェックボックスが完了していることを確認
2. 🧪 `flutter analyze`でエラー0、警告0を確認
3. 🚀 `flutter test`で全テスト成功を確認
4. 📚 ドキュメント更新完了を確認
5. 🗑️ **このTASK_LIST.mdファイルを削除**

---

*最終更新: 2025年7月29日*
*担当者: GitHub Copilot + 開発チーム*
